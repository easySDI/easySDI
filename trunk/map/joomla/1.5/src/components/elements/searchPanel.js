
Ext.namespace("EasySDI_Map");EasySDI_Map.InnerSearchBar=Ext.extend(Ext.Panel,{wfsLoaded:false,layerStyle:'',searchDesc:null,searchType:null,searchSpatial:0,constructor:function(config,panel){this.panel=panel;EasySDI_Map.SearchPanel.superclass.constructor.apply(this,arguments);if(!componentDisplayOption.SimpleSearchEnable&&!componentDisplayOption.AdvancedSearchEnable){this.hide();}},initComponent:function(){this._selectStyle();var simpleMethodDefaultValue=0;this.simpleMethod=new Ext.form.ComboBox({store:this.panel.searchtypestore,displayField:'item',valueField:'id',value:simpleMethodDefaultValue,typeAhead:true,triggerAction:'all',mode:'local',ctCls:'vshift',width:100});this.simpleMethod.addListener('select',this._simpleMethodSelect,this);this.simpleForStores=[];var emptySimpleStore=new Ext.data.SimpleStore({fields:['fid','name'],data:[[0,EasySDI_Map.lang.getLocal('SP_ERROR_NO_WFS')]]});Ext.each(SData.simpleSearchTypes,function(simpleSearch,i){if(simpleSearch.dropDownFeatureType===''){this.simpleForStores.push(emptySimpleStore);}else{var storeOptions={url:componentParams.proxiedPubWfsUrl,featureType:simpleSearch.dropDownFeatureType,featurePrefix:componentParams.pubFeaturePrefix,featureNS:componentParams.pubFeatureNS,fields:[{name:simpleSearch.dropDownIdAttr||'fid',type:'string'},{name:simpleSearch.dropDownDisplayAttr,type:'string'}],queryField:simpleSearch.dropDownDisplayAttr,maxFeatures:componentParams.autocompleteMaxFeat};this.simpleForStores.push(new EasySDI_Map.WfsStore({},storeOptions));}},this);this.simpleFor=new Ext.form.ComboBox({store:this.simpleForStores[simpleMethodDefaultValue],valueField:SData.simpleSearchTypes[simpleMethodDefaultValue].dropDownIdAttr||'fid',displayField:SData.simpleSearchTypes[simpleMethodDefaultValue].dropDownDisplayAttr,loadingText:EasySDI_Map.lang.getLocal('SP_SEARCHING'),width:150,hideTrigger:true,mode:'remote',minChars:componentParams.autocompleteNumChars,beforeBlur:Ext.emptyFn});this.simpleFor.oldInitEvents=this.simpleFor.initEvents;this.simpleFor.initEvents=function(){this.oldInitEvents();this.keyNav.doRelay=function(foo,bar,hname){if(hname=='down'||this.scope.isExpanded()){return Ext.KeyNav.prototype.doRelay.apply(this,arguments);}else if(hname=='enter'){this.scope.onTriggerClick();}
return true;};};this.simpleFor.on('beforequery',function(){this.value='';});this.simpleFor.store.on('load',this._onSimpleForLoad,this.simpleFor);if(SData.localisationLayers.length>0){var storeObject={fields:[{name:'ipa_fullid',type:'string'},{name:'ipa_display_name',type:'string'}],wfslist:[]};Ext.each(SData.localisationLayers,function(loc){var parts=loc.feature_type_name.split(":");storeObject.wfslist.push({url:loc.wfs_url,featureType:parts[1],featurePrefix:parts[0],featureNS:loc.featureNS,fields:[{name:'ipa_fullid',mapping:(componentParams.autocompleteUseFID?'fid':loc.id_field_name),type:'string',prefix:parts[1]},{name:'ipa_display_name',mapping:loc.name_field_name,type:'string',append:" ("+loc.title+")"}],filterField:loc.name_field_name,maxFeatures:componentParams.autocompleteMaxFeat});},this);this.inplacestore=new EasySDI_Map.WfsMultiStore({},storeObject);}else{this.inplacestore=new Ext.data.SimpleStore({fields:['ipa_fullid','ipa_display_name'],data:[['0',EasySDI_Map.lang.getLocal('SP_ERROR_NO_LOCALISATION')]]});}
this.inplaceAutocomplete=new Ext.form.ComboBox({store:this.inplacestore,valueField:'ipa_fullid',displayField:'ipa_display_name',loadingText:EasySDI_Map.lang.getLocal('SP_SEARCHING'),width:140,hideTrigger:true,mode:'remote',minChars:componentParams.autocompleteNumChars,beforeBlur:Ext.emptyFn});this.inplaceAutocomplete.oldInitEvents=this.inplaceAutocomplete.initEvents;this.inplaceAutocomplete.initEvents=function(){this.oldInitEvents();this.keyNav.doRelay=function(foo,bar,hname){if(hname=='down'||this.scope.isExpanded()){return Ext.KeyNav.prototype.doRelay.apply(this,arguments);}else if(hname=='enter'){this.scope.onTriggerClick();}
return true;};};this.inplaceAutocomplete.on('beforequery',function(){this.value='';});this.inplaceAutocomplete.store.on('load',function(){if(this.store.proxy.responses){var complete=true;Ext.each(this.store.proxy.responses,function(response){if(response.priv){if(response.priv.readyState!=4)
complete=false;}},this);if(complete&&this.store.getCount()==1){var r=this.store.getAt(0);this.setValue(r.data[this.valueField]);}}},this.inplaceAutocomplete);if(SData.localisationLayers.length===0){this.inplaceAutocomplete.setValue('0');}
this.simpleGoButton=new Ext.Toolbar.Button({text:EasySDI_Map.lang.getLocal('SP_SIMPLE_SEARCH_GO'),cls:'x-form-toolbar-standardButton'});this.simpleGoButton.addListener('click',this._simpleGoClick,this);if(!SData.searchLayer){this.simpleGoButton.disable();}
var initial_value=null;if(this.panel.methodstore.data.items[0]){initial_value=this.panel.methodstore.data.items[0].data.id;}
this.advancedMethod=new Ext.form.ComboBox({store:this.panel.methodstore,displayField:'method',valueField:'id',value:initial_value,typeAhead:true,triggerAction:'all',mode:'local',ctCls:'vshift',width:170});if(initial_value==null){this.advancedMethod.hide();}
var advancedGoButton=new Ext.Toolbar.Button({text:EasySDI_Map.lang.getLocal('SP_ADV_SEARCH_GO'),cls:'x-form-toolbar-standardButton'});advancedGoButton.addListener('click',this._advancedGoClick,this);if(!SData.searchLayer){advancedGoButton.disable();}
var loadButton=new Ext.Toolbar.Button({hidden:!componentParams.authorisedTo.SEARCH_SAVE_LOAD||!user.loggedIn,xtype:"tbbutton",iconCls:"x-btn-icon loadBtn",tooltip:EasySDI_Map.lang.getLocal('SP_OPEN_SEARCH_TTIP')});loadButton.addListener('click',this._loadSearch,this);var saveButton=new Ext.Toolbar.Button({hidden:!componentParams.authorisedTo.SEARCH_SAVE_LOAD||!user.loggedIn,xtype:"tbbutton",iconCls:"x-btn-icon saveBtn",tooltip:EasySDI_Map.lang.getLocal('SP_SAVE_SEARCH_TTIP')});saveButton.addListener('click',this._saveSearch,this);this.removeButton=new Ext.Toolbar.Button({iconCls:"x-btn-icon removeSearchBtn",tooltip:EasySDI_Map.lang.getLocal('SP_REMOVE_SEARCH')});this.removeButton.addListener('click',function(){this.panel.trigger('removeSearchBar',this);this.panel.ownerCt.doLayout();},this);var clearButton=new Ext.Toolbar.Button({iconCls:"x-btn-icon clearSearchBtn",tooltip:EasySDI_Map.lang.getLocal('SP_CLEAR_SEARCH')});clearButton.addListener('click',function(){this.panel.trigger('clearSearchBar',this);this.panel.ownerCt.doLayout();},this);this.addButton=new Ext.Toolbar.Button({iconCls:"x-btn-icon addSearchBtn",tooltip:EasySDI_Map.lang.getLocal('SP_ADD_SEARCH')});this.addButton.addListener('click',function(){this.panel.trigger('addSearchBar',null);this.panel.ownerCt.doLayout();},this);var addRemoveBar=new Ext.Toolbar({region:"east",height:35,width:70,items:[clearButton,this.removeButton,this.addButton]});var spacer=new Ext.Panel({border:false,width:100});var defConfig;if(componentDisplayOption.SimpleSearchEnable&&componentDisplayOption.AdvancedSearchEnable){defConfig={border:false,layout:"border",height:30,items:[{height:30,xtype:"toolbar",region:"center",items:[(this.barIdx+1).toString(),{xtype:'tbseparator'},{xtype:'box',autoEl:{tag:'img',src:'templates/easysdi_map/icons/silk/find.png'}},EasySDI_Map.lang.getLocal('SP_SEARCH'),this.simpleMethod,EasySDI_Map.lang.getLocal('SP_FOR'),this.simpleFor,EasySDI_Map.lang.getLocal('SP_IN_PLACE'),this.inplaceAutocomplete,' ',this.simpleGoButton,spacer,{xtype:'box',autoEl:{tag:'img',src:'templates/easysdi_map/icons/silk/find.png'}},EasySDI_Map.lang.getLocal('SP_BUILD_ADV_SEARCH'),this.advancedMethod,' ',advancedGoButton,loadButton,saveButton,{xtype:'tbspacer'},{xtype:'tbseparator'}]},addRemoveBar]};};if(!componentDisplayOption.SimpleSearchEnable&&componentDisplayOption.AdvancedSearchEnable){defConfig={border:false,layout:"border",height:30,items:[{height:30,xtype:"toolbar",region:"center",items:[(this.barIdx+1).toString(),{xtype:'tbseparator'},{xtype:'box',autoEl:{tag:'img',src:'templates/easysdi_map/icons/silk/find.png'}},EasySDI_Map.lang.getLocal('SP_BUILD_ADV_SEARCH'),this.advancedMethod,' ',advancedGoButton,loadButton,saveButton,{xtype:'tbspacer'}]},addRemoveBar]};};if(componentDisplayOption.SimpleSearchEnable&&!componentDisplayOption.AdvancedSearchEnable){defConfig={border:false,layout:"border",height:30,items:[{height:30,xtype:"toolbar",region:"center",items:[(this.barIdx+1).toString(),{xtype:'tbseparator'},{xtype:'box',autoEl:{tag:'img',src:'templates/easysdi_map/icons/silk/find.png'}},EasySDI_Map.lang.getLocal('SP_SEARCH'),this.simpleMethod,EasySDI_Map.lang.getLocal('SP_FOR'),this.simpleFor,EasySDI_Map.lang.getLocal('SP_IN_PLACE'),this.inplaceAutocomplete,' ',this.simpleGoButton,{xtype:'tbspacer'}]},addRemoveBar]};};if(!componentDisplayOption.SimpleSearchEnable&&!componentDisplayOption.AdvancedSearchEnable){defConfig={};};Ext.applyIf(this,defConfig);this.featureGrid=null;this.distinctGrids=[];this.selectionGrid=null;this.layers=[];this.gridConfig=null;this.on('resize',function(cmp,adjWidth,adjHeight,rawWidth,rawHeight){var size=cmp.getSize();if(size.width<1000){this.simpleGoButton.setText('>>');advancedGoButton.setText('>>');this.inplaceAutocomplete.setWidth(90);this.simpleFor.setWidth(95);this.advancedMethod.setWidth(120);spacer.setWidth(8);addRemoveBar.setWidth(25);loadButton.setVisible(false);saveButton.setVisible(false);this.removeButton.setVisible(false);this.addButton.setVisible(false);}else if(size.width<1270){this.inplaceAutocomplete.setWidth(100);this.simpleFor.setWidth(105);spacer.setWidth(25);}},this);EasySDI_Map.InnerSearchBar.superclass.initComponent.call(this);},_selectStyle:function(){if(SData.searchLayer&&typeof SData.searchLayer.styles!=="undefined"){if(typeof SData.searchLayer.barIdx=="undefined"){SData.searchLayer.barIdx=0;}else{SData.searchLayer.barIdx++;}
this.barIdx=SData.searchLayer.barIdx;this.layerStyle=SData.searchLayer.styles[this.barIdx%SData.searchLayer.styles.length];}},_onSimpleForLoad:function(){if(this.store.getCount()==1){var r=this.store.getAt(0);this.setValue(r.data[this.valueField]);}},_simpleMethodSelect:function(){this.simpleFor.collapse();this.simpleFor.clearValue();this.simpleFor.lastQuery=null;this.simpleFor.valueField=SData.simpleSearchTypes[this.simpleMethod.value].dropDownIdAttr||'fid';this.simpleFor.displayField=SData.simpleSearchTypes[this.simpleMethod.value].dropDownDisplayAttr||'name';if(SData.simpleSearchTypes[this.simpleMethod.value].dropDownFeatureType===''){this.simpleFor.mode='local';this.simpleFor.minChars=0;}else{this.simpleFor.mode='remote';this.simpleFor.minChars=componentParams.autocompleteNumChars;}
if(this.simpleFor.view){Ext.destroy(this.simpleFor.view);}
if(this.simpleFor.list){this.simpleFor.list.destroy();this.simpleFor.list=null;}
this.simpleFor.tpl=null;this.simpleFor.store.un('load',this._onSimpleForLoad,this.simpleFor);this.simpleFor.bindStore(this.simpleForStores[this.simpleMethod.value],false);this.simpleFor.store.on('load',this._onSimpleForLoad,this.simpleFor);this.simpleFor.initList();if(this.simpleFor.mode=='local'){this.simpleFor.setValue(0);}},_simpleGoClick:function(){this.gridConfig=SData.simpleSearchTypes[this.simpleMethod.value].gridConfig;if((this.simpleFor.value===undefined||this.simpleFor.value==="")&&(this.inplaceAutocomplete.value===undefined||this.inplaceAutocomplete.value==="")){alert(EasySDI_Map.lang.getLocal('SP_ENTER_VALUES'));return;}
var searchConfig=SData.simpleSearchTypes[this.simpleMethod.value];this.filter=this.panel._getFilter(this,searchConfig);this.panel.trigger('doSearch',{searchBar:this});this.searchDesc=EasySDI_Map.lang.getLocal('SP_SEARCH')+' '+searchConfig.title;if(typeof this.simpleFor.value!="undefined"&&this.simpleFor.value!=""){this.searchDesc+=' '+EasySDI_Map.lang.getLocal('SP_FOR')+' '+this.simpleFor.lastSelectionText;this.searchSpatial=0;}
if(typeof this.inplaceAutocomplete.value!="undefined"&&this.inplaceAutocomplete.value!=""){this.searchDesc+=' '+EasySDI_Map.lang.getLocal('SP_IN_PLACE')+' '+this.inplaceAutocomplete.lastSelectionText;this.searchSpatial=1;}
this.searchType=SData.simpleSearchTypes[this.simpleMethod.value].untranslatedTitle;},_advancedGoClick:function(){this.gridConfig={distinctResultsGrids:[],rowDetailsFeatureType:SData.searchLayer.rowDetailsFeatureType};this.panel.trigger('showFilterPanel',this);this.panel.trigger('filterPanel.setMode',this.advancedMethod.getValue());this.panel.trigger('filterPanel.updateFilter');},_loadSearch:function(){var dlg=new EasySDI_Map.Dlg.LoadFilter();dlg.registerTrigger('loadFilter',this.loadFilter.createDelegate(this));dlg.show();},_saveSearch:function(evt){if(typeof this.searchDesc=="undefined"||this.searchDesc===""){alert(EasySDI_Map.lang.getLocal('SP_NO_SEARCH_TO_SAVE'));}else{var dlg=new EasySDI_Map.Dlg.SaveFilter({data:{description:this.searchDesc,filter_data:this.filterData,filter_mode:this.advancedMethod.getValue()}});dlg.show();}},loadFilter:function(filter){this.searchDesc=filter.description;this.filterData=filter.filter_data;this.advancedMethod.setValue(filter.filter_mode);this._advancedGoClick();},zoomToExtent:function(){Ext.each(this.layers,function(layer){if(layer.CLASS_NAME=="OpenLayers.Layer.Vector"){this.panel.trigger('zoomToExtent',layer.getDataExtent());return;}},this);}});EasySDI_Map.SearchPanel=Ext.extend(Ext.Panel,{constructor:function(config){this.methodstore=new Ext.data.SimpleStore({fields:['id','method'],data:this._getAvailableSearchTypes()});var simpleTypeList=[];Ext.each(SData.simpleSearchTypes,function(type,i){simpleTypeList.push([i,type.title]);},this);this.searchtypestore=new Ext.data.SimpleStore({fields:['id','item'],data:simpleTypeList});if(SData.localisationLayers.length===0){}
config.autoHeight=true;EasySDI_Map.SearchPanel.superclass.constructor.apply(this,arguments);},_getAvailableSearchTypes:function(){var result=[];var searchForAnyEnabled=componentParams.authorisedTo.ADV_SEARCH_MISC||componentParams.authorisedTo.ADV_SEARCH_PLACE;return result;},getNewSearchBar:function(searchManager,idx){var innerSearchBar=new EasySDI_Map.InnerSearchBar({},this);innerSearchBar.addListener('beforedestroy',function(){if(this.featureGrid!==null){this.featureGrid.destroy();}
if(this.selectionGrid!==null){this.selectionGrid.destroy();}});if(idx===undefined||idx===null){this.add(innerSearchBar);}else{this.insert(idx,innerSearchBar);}
this.doLayout();return innerSearchBar;},_getFilter:function(innerSearchBar,searchConfig){var filters=[];if(innerSearchBar.simpleFor.value!==undefined){var val;if(innerSearchBar.simpleFor.value.indexOf('.')!=-1){var parts=innerSearchBar.simpleFor.value.split(".");val=parts[1];}else{val=innerSearchBar.simpleFor.value;}
filters.push(new OpenLayers.Filter.Comparison({type:searchConfig.operator||"==",property:searchConfig.searchAttribute,value:val}));}
Ext.each(searchConfig.additionalFilters,function(filterConfig){filters.push(new OpenLayers.Filter.Comparison({type:filterConfig.operator||"==",property:filterConfig.attribute,value:filterConfig.value}));},this);if(innerSearchBar.inplaceAutocomplete.value!==undefined){for(var i=innerSearchBar.inplaceAutocomplete.store.getCount()-1;i>=0;i--){var record=innerSearchBar.inplaceAutocomplete.store.getAt(i);if(record.data.ipa_fullid==innerSearchBar.inplaceAutocomplete.value){if(componentParams.useVectorisedLocations){var id;var level1=innerSearchBar.inplaceAutocomplete.value.split(':');var featureType=level1[0];if(componentParams.autocompleteUseFID){var level2=level1[1].split('.');id=level2[1];}else{id=level1[1];}
filters.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE,value:id,property:featureType+(user.loggedIn?"_private":"_public")+'_keylist'}));}else{filters.push(new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,value:record.data.feature.geometry,property:SData.searchLayer.geometryName}));}}}}
if(filters.length==1){return filters[0];}else{return new OpenLayers.Filter.Logical({filters:filters,type:OpenLayers.Filter.Logical.AND});}}});Ext.mixin(EasySDI_Map.SearchPanel,EasySDI_Map.TriggerManager);