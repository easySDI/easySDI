/**
 * Name: Gemetclient
 * Purpose: Graphical ExtJS-based JavaScript client for GEMET Thesaurus
 * Author: Stepan Kafka <kafka email cz>
 * Copyright: Help Service - Remote Sensing s.r.o 2009
 * URL: http://bnhelp.cz
 * Licence: GNU/LGPL v3
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 */
var ThesaurusReader=function(config){this.url="http://www.eionet.europa.eu/gemet/";this.thesauri={};this.narrower="http://www.w3.org/2004/02/skos/core%23narrower";this.broader="http://www.w3.org/2004/02/skos/core%23broader";this.related="http://www.w3.org/2004/02/skos/core%23related";this.thesauriInit={'GEMET':{concept:"http://www.eionet.europa.eu/gemet/concept/",theme:"http://www.eionet.europa.eu/gemet/theme/",group:"http://www.eionet.europa.eu/gemet/group/",supergroup:"http://www.eionet.europa.eu/gemet/supergroup/"},'INSPIRE':{url:"http://www.eionet.europa.eu/gemet/",concept:"http://inspire.ec.europa.eu/theme/",theme:"http://inspire.ec.europa.eu/theme",group:null,supergroup:null,firstClick:true}};this.appPath="";if(config.appPath)this.appPath=config.appPath;this.proxy=this.appPath+"proxy.php?url=";this.lang='en';this.outputLangs=['cs','en'];this.separator="/";this.returnPath=true;if(config.url)this.url=config.url;if(config.proxy)this.proxy=config.proxy;if(config.lang)this.lang=config.lang;if(config.outputLangs)this.outputLangs=config.outputLangs;if(config.separator)this.separator=config.separator;if(config.returnPath!='undefined')this.returnPath=config.returnPath;this.handler=config.handler;if(config.thesaurus){for(thesName in config.thesaurus){if(config.thesaurus[thesName].url){this.thesauri[thesName]=config.thesaurus[thesName];}
else{this.thesauri[thesName]=this.thesauriInit[thesName];}}}
else{this.thesauri=this.thesauriInit;}
this.data=null;this.theMask=null;this.status=0;var termsStore=new Ext.data.Store({url:this.proxy,baseParams:{url:''},language:this.lang,reader:new Ext.data.JsonReader({root:'results',idProperty:'term',fields:[{name:'id',mapping:'uri'},{name:'term',mapping:'preferredLabel.string'},{name:'definition',mapping:'definition'}]})});this.whisperCfg=function(obj,o){var conceptURI=this.thesauri[this.selectThes.value].concept;var addr=this.thesauri[this.selectThes.value].url;if(!addr)addr=this.url;obj.baseParams.url=addr+"getConceptsMatchingRegexByThesaurus?thesaurus_uri="+conceptURI+"&language="+this.lang+"&regex="+escape(obj.baseParams.query);};termsStore.on('beforeload',this.whisperCfg,this,{});this.whisperSelect=function(cbox,record){var node={text:record.data.term,attributes:{termId:record.data.id,data:{definition:record.data.definition}}};this.getById(node);};var searchField=new Ext.form.ComboBox({store:termsStore,width:150,minChars:3,displayField:'term',listeners:{'select':this.whisperSelect,scope:this},obj:this});this.showError=function(){Ext.Msg.alert('Error','Source not found at:'+this.url);this.theMask.hide();};this.drawTerms=function(r,o){this.theMask.hide();var root=o.options.node;root.getUI().getIconEl().src=Ext.BLANK_IMAGE_URL;root.getUI().getIconEl().className="x-tree-node-icon";if(r.responseText){try{var data=Ext.util.JSON.decode(r.responseText);if(data.results)this.drawBranch(root,data.results);root.expand();}
catch(e){alert('Data error!');}}};this.drawBranch=function(root,data){var uri=this.thesauri[this.selectThes.value];for(var i=0;i<data.length;i++){if(data[i].uri.indexOf(uri.theme)>-1)var icon=this.appPath+'img/theme.gif';else if(data[i].uri.indexOf(uri.group)>-1)var icon=this.appPath+'img/group.gif';else var icon=this.appPath+'img/term.gif';var node=new Ext.tree.TreeNode({text:data[i].preferredLabel.string,termId:data[i].uri,data:data[i],icon:icon,cls:'thes-link'});if(uri.firstClick){node.on('click',this.returnTerm,this,data[i].termId);}
else node.on('click',this.getById,this,data[i].termId);root.appendChild(node);}};this.emptyTree=function(){var root=this.thesRoot;while(root.item(0))root.removeChild(root.item(0));};this.getByTerm=function(){this.obj.emptyTree();this.obj.detailPanel.collapse();this.obj.treePanel.topToolbar.hide();if(this.getValue().length<this.minLength){Ext.Msg.alert(HS.i18n('Warning'),'&gt;= '+this.minLength+' '+HS.i18n('characters required'));return false;}
if(!this.obj.theMask)this.obj.theMask=new Ext.LoadMask(this.obj.body);this.obj.theMask.show();this.obj.thesRoot.setText(HS.i18n('Found'));var conceptURI=this.obj.thesauri[this.obj.selectThes.value].concept;Ext.Ajax.request({url:this.obj.prepareRequest("getConceptsMatchingRegexByThesaurus?thesaurus_uri="+conceptURI+"&language="+this.obj.lang+"&regex="+this.getValue()),scope:this.obj,options:{node:this.obj.thesRoot},success:this.obj.drawTerms,failure:this.obj.showError});};this.getTopConcepts=function(){var conceptURI=this.thesauri[this.selectThes.value].concept;this.emptyTree();this.treePanel.topToolbar.hide();this.detailPanel.body.update('');this.detailPanel.collapse();if(!this.theMask)this.theMask=new Ext.LoadMask(this.body);this.theMask.show();this.thesRoot.setText(HS.i18n('Top concepts'));Ext.Ajax.request({url:this.prepareRequest("getTopmostConcepts?thesaurus_uri="+conceptURI+"&language="+this.lang),scope:this,options:{node:this.thesRoot},success:this.drawTerms,failure:this.showError});};this.getById=function(theNode){if(!this.theMask)this.theMask=new Ext.LoadMask(this.body);this.data=theNode.attributes.termId;this.emptyTree();this.treePanel.topToolbar.show();this.thesRoot.setText(theNode.text);var theTitle=this.treePanel.topToolbar.items.item(0);theTitle.setText("<span class='thes-term'><b>"+theNode.text+"</b></span>");if(theNode.attributes.data.definition){this.detailPanel.body.update(theNode.attributes.data.definition.string);this.detailPanel.expand();}
else{this.detailPanel.body.update('');this.detailPanel.collapse();}
var nt=new Ext.tree.TreeNode({text:HS.i18n("NT"),termId:'nt',icon:this.appPath+'img/indicator.gif'});this.thesRoot.appendChild(nt);Ext.Ajax.request({url:this.prepareRequest("getRelatedConcepts?concept_uri="+theNode.attributes.termId+"&relation_uri="+this.narrower+"&language="+this.lang),scope:this,options:{node:nt},success:this.drawTerms,failure:this.showError});var bt=new Ext.tree.TreeNode({text:HS.i18n("BT"),termId:'bt',icon:this.appPath+'img/indicator.gif'});this.thesRoot.appendChild(bt);Ext.Ajax.request({url:this.prepareRequest("getRelatedConcepts?concept_uri="+theNode.attributes.termId+"&relation_uri="+this.broader+"&language="+this.lang),scope:this,options:{node:bt},success:this.drawTerms,failure:this.showError});var rt=new Ext.tree.TreeNode({text:HS.i18n("RT"),termId:'rt',icon:this.appPath+'img/indicator.gif'});this.thesRoot.appendChild(rt);Ext.Ajax.request({url:this.prepareRequest("getRelatedConcepts?concept_uri="+theNode.attributes.termId+"&relation_uri="+this.related+"&language="+this.lang),scope:this,options:{node:rt},success:this.drawTerms,failure:this.showError});var th=new Ext.tree.TreeNode({text:HS.i18n("TH"),termId:'th',icon:this.appPath+'img/indicator.gif'});this.thesRoot.appendChild(th);Ext.Ajax.request({url:this.prepareRequest("getRelatedConcepts?concept_uri="+theNode.attributes.termId+"&relation_uri=http://www.eionet.europa.eu/gemet/2004/06/gemet-schema.rdf%23theme&language="+this.lang),scope:this,options:{node:th},success:this.drawTerms,failure:this.showError});this.thesRoot.expand();};this.prepareRequest=function(arg){var url=this.thesauri[this.selectThes.value].url;if(!url)url=this.url;url+=arg;if(this.proxy)return this.proxy+escape(url);else return url;};this.returnTerm=function(obj){if(obj.xtype!='button')this.data=obj.attributes.termId;this.theMask.show();this.output={terms:{},uri:'',version:''};this.status=0;for(var i=0;i<this.outputLangs.length;i++){Ext.Ajax.request({url:this.prepareRequest("getConcept?concept_uri="+this.data+"&language="+this.outputLangs[i]),scope:this,success:this.getConceptBack,failure:this.showError});}};this.getBroaderConcept=function(uri,lang){Ext.Ajax.request({url:this.prepareRequest("getRelatedConcepts?concept_uri="+uri+"&relation_uri="+this.broader+"&language="+lang),scope:this,success:this.getConceptBack,failure:this.showError});};this.getConceptBack=function(r,o){if(r.responseText){try{var data=Ext.util.JSON.decode(r.responseText);data=data.results;if(!data.preferredLabel){for(var i=0;i<data.length;i++){if(data[i].uri.indexOf(this.thesauri[this.selectThes.value].concept)>-1){data=data[i];break;}}
if(!data.preferredLabel){this.finishTerm();return;}}
if(!this.output.terms[data.preferredLabel.language]){this.output.terms[data.preferredLabel.language]=data.preferredLabel.string;this.output.uri=data.uri;}
else this.output.terms[data.preferredLabel.language]=data.preferredLabel.string+this.separator+this.output.terms[data.preferredLabel.language];if(this.returnPath)this.getBroaderConcept(data.uri,data.preferredLabel.language);else this.finishTerm();}
catch(e){alert('Data error!');}}
else{this.finishTerm();}};this.finishTerm=function(){this.status++;if(this.status==this.outputLangs.length){Ext.Ajax.request({url:this.prepareRequest("getAvailableThesauri"),scope:this,success:this.returnTerms,failure:this.showError});}};this.returnTerms=function(r,o){var data=Ext.util.JSON.decode(r.responseText);for(var i=0;i<data.results.length;i++){if(this.output.uri.indexOf(data.results[i].uri)>-1){this.output.version=data.results[i].version;break;}}
this.theMask.hide();this.handler.call(config.scope,this.output);};this.detailPanel=new Ext.Panel({height:100,region:'south',collapsed:true,collapseMode:'mini',autoScroll:true,cls:'thes-description',split:true});this.tb=new Ext.Toolbar({items:['.','->',{xtype:'button',text:HS.i18n("Use"),icon:this.appPath+'img/drop-yes.gif',cls:'x-btn-text-icon',handler:this.returnTerm,scope:this}]});this.treePanel=new Ext.tree.TreePanel({layout:'fit',useArrows:true,autoScroll:true,region:'center',tbar:this.tb,rootVisible:true});var thes=new Array();for(th in this.thesauri)thes.push(th);this.selectThes=new Ext.form.ComboBox({store:thes,width:70,stateful:true,stateId:"thesaurus-selected",typeAhead:true,selectOnFocus:true,triggerAction:'all',cls:'thes-select',value:config.defaultThesaurus||thes[0],mode:'local'});this.thesRoot=new Ext.tree.TreeNode({draggable:true,allowChildren:true,leaf:false,singleClickExpand:true,text:'',cls:'thes-root',expanded:true});this.tb.hide();this.treePanel.setRootNode(this.thesRoot);config.layout='border';config.tbar=[this.selectThes,{handler:function(){this.getTopConcepts();},icon:this.appPath+'img/top.gif',cls:'x-btn-icon',tooltip:HS.i18n('Top concepts'),scope:this},"-",HS.i18n("Search")+': ',searchField];config.items=[this.detailPanel,this.treePanel];ThesaurusReader.superclass.constructor.call(this,config);};Ext.extend(ThesaurusReader,Ext.Panel,{});HS={};HS.lang=null;HS.defaultLang="eng";HS.allLangsSet=false;HS.Lang={};HS.i18n=function(){if(!HS.getLang()){HS.setLang(HS.defaultLang);}
var trans=null;var KEY=null;if(typeof(arguments[0])==typeof({})){trans=arguments[0];KEY=arguments[1];}
else{trans=HS.Lang;KEY=arguments[0];}
var retString="";for(var lang in trans){if(lang==this.lang){retString=trans[this.lang][KEY];}}
return(retString?retString:KEY);};HS.setLang=function(code,saveToCookie){if(HS.allLangsSet==false){var hsset=false;var olset=false;var hscode=null;var olcode=null;for(var l in HS.langs){breakthis=false;var keys=HS.langs[l];for(var i=0;i<keys.length;i++){if(keys[i]==code){hscode=l.split(";")[0];olcode=this.getOLCode(hscode);breakthis=true;break;}}
if(breakthis){break;}}
if(hscode==null){hscode="eng";olcode="en";}
this.lang=hscode;if(saveToCookie==true){this.setCookie("lang",hscode);}
hsset=true;try{OpenLayers.Lang.setCode(olcode);olset=true;}catch(e){}
if(olset&&hsset){}}
return true;};HS.getLang=function(type){if(!type){type=3;}
if(!HS.lang){return null;}
else{return HS.getCodeFromLanguage(HS.lang,type);}};HS.getLastLangCode=function(){var code=null;if(window.location.search.length>0){var search=window.location.search;var params=search.substr(1,search.length);params=params.split("&");for(var i=0;i<params.length;i++){var param=params[i].split("=");if(param[0]=="lang"){code=HS.getCodeFromLanguage(param[1],3);}}}
if(!code){try{code=HS.getCookie("lang");code=HS.getCodeFromLanguage(code);}
catch(e){}}
return code;};HS.getCodeFromLanguage=function(code,type){if(!type){type=3;}
for(var l in HS.langs){breakthis=false;var keys=HS.langs[l];for(var i=0;i<keys.length;i++){if(keys[i]==code){codes=l.split(";");switch(type){case 2:return codes[2];break;case 3:return codes[0];break;case"ol":return codes[0];break;default:return"eng";break;}}}}
return null;};HS.setCookie=function(c_name,value,expiredays){var exdate=new Date();exdate.setDate(exdate.getDate()+expiredays);document.cookie=c_name+"="+escape(value)+
((expiredays==null)?"":";expires="+exdate.toGMTString());};HS.getCookie=function(c_name){if(document.cookie.length>0){c_start=document.cookie.indexOf(c_name+"=");if(c_start!=-1){c_start=c_start+c_name.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1)c_end=document.cookie.length;return unescape(document.cookie.substring(c_start,c_end));}}
return"";};HS.langs={"eng;en;en":["en","eng","english"],"ger;de;de":["de","ger","deutsch"],"fre;fr;fr":["fr","fre","fra","france"],"pol;pl;pl":["pl","pol","polska"],"cze;cs-CZ;cs":["cz","cze","cs-CZ","czech","cesky","cs"],"lav;lv-LV;lv":["lv","lav","lv-LV","latvian","latv"],"swe;sv;sv":["sv","swe","swedish"],"nor;no;no":["no","nor","norweign"],"por;pt;pt":["pt","por","portugese"],"ita;it;it":["it","ita","italian"],"dan;da;da":["da","dan","danish"],"slo;sk;sk":["sk","slo","slovak"],"fin;fi;fi":["fi","fin","finnish"],"spa;es;es":["es","spa","spanish"],"hun;hu;hu":["hu","hun","hungarian"],"slv;sl;sl":["sl","slv","slovenian"]},HS.initLangs=function(){for(var lang in this.langs){HS.Lang[lang.split(";")[0]]={};}};HS.getOLCode=function(code){for(var c in this.langs){var codes=c.split(";");if(code==codes[0]){return(codes.length>1?codes[1]:codes[0]);}}
return"en";};HS.setDefaultLanguage=function(){var lastLang=HS.getLastLangCode();if(!lastLang){lastLang=HS.defaultLang;}
HS.setLang(lastLang);};HS.initLangs();HS.Lang["cze"]["Home"]="Výchozí";HS.Lang["cze"]["Search"]="Hledat";HS.Lang["cze"]["BT"]="Širší termíny";HS.Lang["cze"]["NT"]="Užší termíny";HS.Lang["cze"]["RT"]="Příbuzné termíny";HS.Lang["cze"]["Use"]="Použít";HS.Lang["cze"]["Themes"]="Témata";HS.Lang["cze"]["Groups"]="Skupiny";HS.Lang["cze"]["Warning"]="Výstraha";HS.Lang["cze"]["characters required"]="znaků vyžadováno";HS.Lang["cze"]["Top concepts"]="Výchozí témata";HS.Lang["cze"]["Found"]="Nalezeno";HS.Lang["cze"]["INSPIRE themes"]="INSPIRE - témata";HS.Lang["cze"]['GEMET top concepts']="GEMET - základní koncepty";HS.Lang["eng"]["BT"]="Broader terms";HS.Lang["eng"]["NT"]="Narrower terms";HS.Lang["eng"]["RT"]="Related terms";