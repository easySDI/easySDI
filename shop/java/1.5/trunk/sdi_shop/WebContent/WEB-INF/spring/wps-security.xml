<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
          http://www.springframework.org/schema/context 
          http://www.springframework.org/schema/context/spring-context-3.0.xsd
          http://www.springframework.org/schema/security
          http://www.springframework.org/schema/security/spring-security-3.0.xsd">

	<!--
		<context:property-placeholder
		location="/WEB-INF/wps-config.properties" />
	-->

	<bean id="propertyPlaceholderConfigurer"
		class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="locations">
			<list>
				<value>/WEB-INF/wps-config.properties</value>
			</list>
		</property>
	</bean>


	<!-- Class for reading properties within application -->
	<bean id="jDataSource" class="org.easysdi.services.wps.JDataSource">
		<property name="jdbcUrl">
			<value>${joomla.jdbc.url}</value>
		</property>
		<property name="jdbcUser">
			<value>${joomla.jdbc.user}</value>
		</property>
		<property name="jdbcPwd">
			<value>${joomla.jdbc.password}</value>
		</property>
		<property name="jPrefix">
			<value>${joomla.prefix}</value>
		</property>
		<property name="jdbcDriver">
			<value>${joomla.jdbc.driver}</value>
		</property>
		<property name="jplatformname">
			<value>${joomla.platformname}</value>
		</property>
		<property name="jlanguagefile">
			<value>${joomla.languagefile}</value>
		</property>
		<property name="jSender">
			<value>${joomla.sender}</value>
		</property>
		<property name="jSenderTitle">
			<value>${joomla.sendertitle}</value>
		</property>
	</bean>

	<!-- Hibernate beans -->
	<bean id="joomlaDataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource"
		destroy-method="close">
		<property name="driverClass">
			<value>${joomla.jdbc.driver}</value>
		</property>
		<property name="jdbcUrl">
			<value>${joomla.jdbc.url}</value>
		</property>
		<property name="user">
			<value>${joomla.jdbc.user}</value>
		</property>
		<property name="password">
			<value>${joomla.jdbc.password}</value>
		</property>
		<property name="initialPoolSize">
			<value>${joomla.c3p0.initialPoolSize}</value>
		</property>
		<property name="minPoolSize">
			<value>${joomla.c3p0.minPoolSize}</value>
		</property>
		<property name="maxPoolSize">
			<value>${joomla.c3p0.maxPoolSize}</value>
		</property>
		<property name="acquireRetryAttempts">
			<value>${joomla.c3p0.acquireRetryAttempts}</value>
		</property>
		<property name="acquireIncrement">
			<value>${joomla.c3p0.acquireIncrement}</value>
		</property>
		<property name="idleConnectionTestPeriod">
			<value>${joomla.c3p0.idleConnectionTestPeriod}</value>
		</property>
		<property name="maxIdleTime">
			<value>${joomla.c3p0.maxIdleTime}</value>
		</property>
		<property name="maxConnectionAge">
			<value>${joomla.c3p0.maxConnectionAge}</value>
		</property>
		<property name="preferredTestQuery">
			<value>${joomla.c3p0.preferredTestQuery}</value>
		</property>
		<property name="testConnectionOnCheckin">
			<value>${joomla.c3p0.testConnectionOnCheckin}</value>
		</property>
	</bean>

	<security:authentication-manager alias="authenticationManager">
		<security:authentication-provider
			ref="joomlaProvider" />
	</security:authentication-manager>

	<bean
		class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetClass"
			value="org.springframework.security.core.context.SecurityContextHolder" />
		<property name="targetMethod" value="setStrategyName" />
		<property name="arguments">
			<list>
				<value>MODE_INHERITABLETHREADLOCAL</value>
			</list>
		</property>
	</bean>

	<bean id="joomlaProvider" class="org.easysdi.security.JoomlaProvider">
		<property name="prefix">
			<value>${joomla.prefix}</value>
		</property>
		<property name="version" value="2.1.1" />
		<property name="dataSource" ref="joomlaDataSource" />
	</bean>

	<security:http auto-config="false"
		access-decision-manager-ref="accessDecisionManager" path-type="regex">
		<security:http-basic />
		<security:anonymous username="spring2a2d595e6ed9a0b24f027f2b63b134d6"
			granted-authority="anonymous" />
		<security:intercept-url pattern="(.*)" access="proxy_user" />
		<security:custom-filter ref="joomlaCookieAuthenticationFilter"
			before="BASIC_AUTH_FILTER" />

		<!--
			<security:custom-filter ref="easySdiConfigFilter"
			after="FILTER_SECURITY_INTERCEPTOR" /> <security:custom-filter
			ref="getMapCacheFilter" position="LAST" />
		-->
	</security:http>

	<bean id="basicAuthenticationEntryPoint"
		class="org.springframework.security.web.authentication.www.BasicAuthenticationEntryPoint">
		<property name="realmName">
			<value>EasySDI Publish Security</value>
		</property>
	</bean>

	<bean id="accessDecisionManager"
		class="org.springframework.security.access.vote.AffirmativeBased">
		<property name="decisionVoters">
			<list>
				<ref bean="authenticatedVoter" />
				<ref bean="roleVoter" />
			</list>
		</property>
	</bean>
	<bean id="roleVoter" class="org.springframework.security.access.vote.RoleVoter">
		<property name="rolePrefix" value="" />
	</bean>

	<bean id="authenticatedVoter"
		class="org.springframework.security.access.vote.AuthenticatedVoter" />

	<bean id="joomlaCookieAuthenticationFilter" class="org.easysdi.security.JoomlaCookieAuthenticationFilter">
		<property name="joomlaProvider" ref="joomlaProvider" />
		<property name="authenticationManager" ref="authenticationManager" />
		<property name="authenticationEntryPoint" ref="basicAuthenticationEntryPoint" />
	</bean>

</beans>
