
Ext.namespace("EasySDI_Map");EasySDI_Map.FeatureDetails=Ext.extend(EasySDI_Map.ReportBase,{constructor:function(config){var formPanel=new Ext.form.FormPanel({labelWidth:200,border:false,autoScroll:true,anchors:"100% 100%",buttonAlign:"right"});if(user.loggedIn&&typeof SData.commentFeatureType!=="undefined"){formPanel.addButton({text:EasySDI_Map.lang.getLocal('Save_comment')},this.saveComment,this);}
this.outputCntr=formPanel;EasySDI_Map.FeatureDetails.superclass.constructor.apply(this,arguments);this.gridPanel.add(formPanel);this.featureId=this.url.filter;var fields=[],props=[];if(SData.detailsReportGeoms[this.url.type]!==undefined){props.push(SData.detailsReportGeoms[this.url.type]);}
Ext.each(SData.attrs[this.url.type],function(attr){props.push(attr.name);if(attr.visible!==false){fields.push({name:attr.name,type:attr.type});}},this);this.protocol=new OpenLayers.Protocol.WFS({url:componentParams.proxiedPubWfsUrl,featureNS:componentParams.pubFeatureNS,featurePrefix:componentParams.pubFeaturePrefix,featureType:this.url.type,srsName:componentParams.projection,version:componentParams.pubWfsVersion,propertyNames:props,filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:this.url.filterfield,value:this.featureId})});var proxy=new GeoExt.data.ProtocolProxy({protocol:this.protocol});var store=new GeoExt.data.FeatureStore({fields:fields,proxy:proxy,srsName:componentParams.projection});store.on('load',this.loadStore,this);store.load();},addExtraControls:function(){var formatstore=new Ext.data.SimpleStore({fields:['id','format'],data:[[0,EasySDI_Map.lang.getLocal('PAG_FORMAT_ADOBE_PDF')],[1,EasySDI_Map.lang.getLocal('PAG_FORMAT_RTF')],[2,EasySDI_Map.lang.getLocal('PAG_FORMAT_CSV')]]});this.downloadFormat=new Ext.form.ComboBox({emptyText:EasySDI_Map.lang.getLocal('Sel_format'),store:formatstore,minListWidth:170,displayField:'format',valueField:'id',typeAhead:true,triggerAction:'all',mode:'local',width:160});this.topPanel=new Ext.Panel({region:"north",height:60,border:false,defaults:{border:false,defaults:{border:false}},items:[{html:'<h1>'+EasySDI_Map.lang.getLocal("FDR_TITLE_"+this.url.type)+'</h1>'},{layout:'column',items:[{html:EasySDI_Map.lang.getLocal("Download_as")+':',width:200},this.downloadFormat,{items:[{xtype:'button',text:EasySDI_Map.lang.getLocal('Download'),width:80,handler:this._downloadReport,scope:this}],width:80},{hidden:true,xtype:'panel',html:'<form id="postform" target="_blank" method="post">'+'<input id="postBody" name="body"/></form>'}]}]});this.sidePanel=new Ext.Panel({region:"east",width:300,border:false});this.rptPanel.add(this.sidePanel);this.rptPanel.add(this.topPanel);},_XMLtoString:function(elem){var serialized;try{serializer=new XMLSerializer();serialized=serializer.serializeToString(elem);}
catch(e){serialized=elem.xml;}
return serialized;},_downloadReport:function(){var dom=new OpenLayers.Format.Filter.v1_0_0().write(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:this.url.filterfield,value:this.featureId}));var filterText=this._XMLtoString(dom);var transform,mimeType,identifier;if(this.downloadFormat.value===0||this.downloadFormat.value==3){transform='fop-default';mimeType='application/pdf';}else{transform='xslt-default';if(this.downloadFormat.value==1){mimeType='application/rtf';}else{mimeType='text/csv';}}
identifier='getListReport';document.getElementById('postBody').value='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'+'<wps:Execute service="WPS" version="1.0.0" xmlns:wps="http://www.opengis.net/wps/1.0.0" '+'xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink" '+'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 ../wpsExecute_request.xsd">'+'<ows:Identifier>'+identifier+'</ows:Identifier>'+'<wps:DataInputs>'+'<wps:Input><ows:Identifier>userName</ows:Identifier>'+'<wps:Data><wps:LiteralData>'+user.name+'</wps:LiteralData>'+'</wps:Data>'+'</wps:Input>'+'<wps:Input><ows:Identifier>filters</ows:Identifier>'+'<wps:Data><wps:LiteralData>record</wps:LiteralData>'+'</wps:Data>'+'</wps:Input>'+'<wps:Input><ows:Identifier>type</ows:Identifier>'+'<wps:Data><wps:LiteralData>Record</wps:LiteralData>'+'</wps:Data>'+'</wps:Input>'+'<wps:Input><ows:Identifier>spatial</ows:Identifier>'+'<wps:Data><wps:LiteralData>0</wps:LiteralData>'+'</wps:Data>'+'</wps:Input>'+'<wps:Input><ows:Identifier>wfsRequest</ows:Identifier>'+'<wps:Data><wps:ComplexData schema="http://schemas.opengis.net/wfs/1.0.0/WFS-basic.xsd" mimeType="text/xml" encoding="UTF-8">'+'<wfs:GetFeature service="WFS" version="'+componentParams.pubWfsVersion+'" outputFormat="GML2" xmlns:wfs="http://www.opengis.net/wfs" '+'xmlns:ogc="http://www.opengis.net/ogc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+'xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/WFS-basic.xsd"> '+'<wfs:Query typeName="'+componentParams.pubFeaturePrefix+':'+this.url.type.replace('{geom}','')+'">'+
this._getProperties()+
filterText+'</wfs:Query></wfs:GetFeature></wps:ComplexData></wps:Data>'+'</wps:Input>'+'</wps:DataInputs>'+'<wps:ResponseForm>'+'<wps:RawDataOutput mimeType="'+mimeType+'"><ows:Identifier>'+transform+'</ows:Identifier></wps:RawDataOutput>'+'</wps:ResponseForm>'+'</wps:Execute>';document.forms.postform.action=componentParams.wpsReportsUrl;document.forms.postform.submit();},_getProperties:function(){var props='';Ext.each(SData.attrs[this.url.type],function(attr){if(attr.visible!==false){props+='<ogc:PropertyName>'+attr.name+'</ogc:PropertyName>';}},this);return props;},displayGeom:function(feature){var savedLayerId=Ext.state.Manager.get('baseLayerState',false);var baseLayer=null;Ext.each(SData.baseLayers,function(layer){if(baseLayer===null&&(savedLayerId==layer.id||!savedLayerId)){baseLayer=layer;}});var bounds=baseLayer.maxExtent;this.mapPanel=new GeoExt.MapPanel({map:{projection:componentParams.projection,minExtent:bounds,maxExtent:bounds,minScale:262,maxScale:262,units:"m",numZoomLevels:1},width:260,height:380,frame:true,style:"margin-left: 20px"});this.sidePanel.add(this.mapPanel);var WMSoptions={basemapscontentid:baseLayer.id,LAYERS:baseLayer.layers,SERVICE:baseLayer.url_type,VERSION:baseLayer.version,STYLES:'',SRS:baseLayer.projection,FORMAT:baseLayer.imageFormat,tiled:'true'};var l=new OpenLayers.Layer.WMS(baseLayer.name,baseLayer.url,WMSoptions);this.mapPanel.map.addLayer(l);var dist;if(feature.geometry===null){var filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE,property:"lineage_keylist",value:this.url.filter});var geom=SData.detailsReportGeoms[SData.searchLayer.featureType.replace('{geom}','')];var featureType=SData.searchLayer.featureType.replace('{geom}',geom);var dom=new OpenLayers.Format.Filter.v1_0_0().write(filter);var filterText=this._XMLtoString(dom);var WMSoptions={VERSION:componentParams.pubWmsVersion,LAYERS:featureType,SRS:componentParams.projection,TRANSPARENT:true,FILTER:filterText,GEOMETRYNAME:geom,STYLES:SData.searchLayer.styles[0]};dist=new OpenLayers.Layer.WMS(layer.name,componentParams.pubWmsUrl,WMSoptions,{isBaseLayer:false});}else{var style=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);dist=new OpenLayers.Layer.Vector('',{style:style});dist.addFeatures([feature]);}
this.mapPanel.map.addLayer(dist);this.mapPanel.map.removeControl(this.mapPanel.map.controls[1]);this.mapPanel.map.controls[0].deactivate();},handleCommentPost:function(evt){if(!evt.success()){alert(evt.priv.responseXML.firstChild.textContent);}
this.getComments();}});Ext.mixin(EasySDI_Map.FeatureDetails,EasySDI_Map.FeatureDetailsHelper);