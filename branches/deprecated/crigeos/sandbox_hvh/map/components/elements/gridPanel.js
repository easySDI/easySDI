
Ext.namespace("EasySDI_Map");var _DATE_FORMAT_REGXES={'Y':new RegExp('^-?[0-9]+'),'d':new RegExp('^[0-9]{1,2}'),'m':new RegExp('^[0-9]{1,2}'),'H':new RegExp('^[0-9]{1,2}'),'M':new RegExp('^[0-9]{1,2}')};function _parseDate(datestring,format){var parsed={};for(var i1=0,i2=0;i1<format.length;i1++,i2++){var c1=format[i1];var c2=datestring[i2];if(c1=='%'){c1=format[++i1];var data=_DATE_FORMAT_REGXES[c1].exec(datestring.substring(i2));if(!data||!data.length){return null;}
data=data[0];i2+=data.length-1;var value=parseInt(data,10);if(isNaN(value)){return null;}
parsed[c1]=value;continue;}
if(c1!=c2){return null;}}
return parsed;}
function strptime(datestring,format){var parsed=_parseDate(datestring,format);if(!parsed){return null;}
var date=new Date(0,0,1,0,0);date.setFullYear(0);if(parsed.Y){date.setFullYear(parsed.Y);}
if(parsed.m){if(parsed.m<1||parsed.m>12){return null;}
date.setMonth(parsed.m-1);}
if(parsed.d){if(parsed.m<1||parsed.m>31){return null;}
date.setDate(parsed.d);}
if(parsed.H){if(parsed.H<0||parsed.H>23){return null;}
date.setHours(parsed.H);}
if(parsed.M){if(parsed.M<0||parsed.M>59){return null;}
date.setMinutes(parsed.M);}
return date;}
EasySDI_Map.GridPanel=Ext.extend(Ext.Panel,{tabPanel:null,constructor:function(config){EasySDI_Map.GridPanel.superclass.constructor.apply(this,arguments);this.addListener('expand',function(){this.trigger('enableWfsSearch');},this);this.addListener('collapse',function(){this.trigger('disableWfsSearch');},this);if(!componentDisplayOption.SimpleSearchEnable&&!componentDisplayOption.AdvancedSearchEnable)
{this.hide();}},addSearch:function(protocol,layers,selectControl,searchBar){var attrs=this._loadAttrs(SData.searchLayer.featureType.replace('{geom}',''));this._initTabPanel();this._initSelectionTab(searchBar,attrs);this._initFeatureTab(protocol,layers,selectControl,searchBar,attrs);this._initDistinctTabs(searchBar);var pos;if(searchBar.ownerCt.items.indexOf(searchBar)===0){pos=0;}else{var barPos=searchBar.ownerCt.items.indexOf(searchBar)-1;while(barPos>=0&&searchBar.ownerCt.items.items[barPos].selectionGrid===null){barPos--;}
if(barPos>=0){var previousBar=searchBar.ownerCt.items.items[barPos];pos=this.tabPanel.items.indexOf(previousBar.selectionGrid)+1;}else{pos=0;}}
this.tabPanel.insert(pos,searchBar.selectionGrid);Ext.each(searchBar.distinctGrids,function(grid){this.tabPanel.insert(pos,grid);},this);this.tabPanel.insert(pos,searchBar.featureGrid);this.expand();this.tabPanel.setActiveTab(searchBar.featureGrid);this.doLayout();},_loadAttrs:function(featureType){var r={fields:[],columns:[]};var catAndName=[],sortType;var visibleCols=Ext.state.Manager.get(featureType+'Cols',null);if(visibleCols===null){visibleCols=SData.defaultAttrs[featureType];}
Ext.each(SData.attrs[featureType],function(attr){var isInGrid=(visibleCols===null||visibleCols.indexOf(attr.name)!=-1);if(isInGrid||attr.visible===false){if(attr.name=='date'){sortType=function(value){return strptime(value,'%d/%m/%Y');};}else{sortType=null;}
r.fields.push({name:attr.name,type:attr.type,pk:attr.name==componentParams.featureIdAttribute,sortType:sortType});}
if((attr.visible||typeof attr.visible=="undefined")){catAndName=EasySDI_Map.lang.getLocal('COL_'+attr.name).split('/');r.columns.push({header:catAndName[1],category:catAndName[0],width:attr.width,sortable:true,dataIndex:attr.name,hidden:!isInGrid});}});return r;},_initTabPanel:function(){if(this.tabPanel===null){this.tabPanel=new Ext.TabPanel();this.add(this.tabPanel);}},_initSelectionTab:function(searchBar,attrs){var selectionStore=new Ext.data.Store({fields:attrs.fields});var gridView=new EasySDI_Map.PagingGridView();var pagingBar=new EasySDI_Map.PagingToolbar({store:selectionStore,displayName:EasySDI_Map.lang.getLocal("GP_SEL_LIST"),pageSize:7,featureType:SData.searchLayer.featureType,listDetailsFeatureType:SData.searchLayer.rowDetailsFeatureType,listDetailsGeometryName:SData.detailsReportGeoms[SData.searchLayer.rowDetailsFeatureType],displayInfo:true,displayMsg:EasySDI_Map.lang.getLocal("GP_PAGE_FOOTER_SEL"),gridView:gridView,includeReportDownload:true,searchDesc:searchBar.searchDesc,searchType:"SELECTION",searchSpatial:searchBar.searchSpatial,idField:componentParams.featureIdAttribute});searchBar.selectionGrid=new Ext.grid.GridPanel({title:EasySDI_Map.lang.getLocal("GP_SEL_LIST"),view:gridView,height:202,store:selectionStore,columns:attrs.columns,bbar:pagingBar});searchBar.selectionGrid.colModel.type=SData.searchLayer.featureType.replace('{geom}','');searchBar.selectionGrid.colModel.on("hiddenchange",this._colHiddenChange,this);this._addContextMenu(searchBar,searchBar.selectionGrid,searchBar.gridConfig,this._getFeatureMenu.createDelegate(this),false);},_initFeatureTab:function(protocol,layers,selectControl,searchBar,attrs){var store=this._initFeatureStore(protocol,layers[0],attrs.fields,searchBar);var selectionModel=new EasySDI_Map.FeatureSelectionModel({layers:layers,selectControl:selectControl,selectList:searchBar.selectionGrid});var gridView=new EasySDI_Map.PagingGridView();var pagingBar=new EasySDI_Map.PagingToolbar({store:store,displayName:EasySDI_Map.lang.getLocal("Occurrences"),featureType:SData.searchLayer.featureType,listDetailsFeatureType:SData.searchLayer.rowDetailsFeatureType,listDetailsGeometryName:SData.detailsReportGeoms[SData.searchLayer.rowDetailsFeatureType],pageSize:7,displayInfo:true,displayMsg:EasySDI_Map.lang.getLocal("GP_PAGE_FOOTER_FEATURE"),gridView:gridView,includeReportDownload:true,includeReloadButton:true,searchDesc:searchBar.searchDesc,searchType:searchBar.searchType,searchSpatial:searchBar.searchSpatial,idField:componentParams.featureIdAttribute});pagingBar.registerTrigger('reloadQuery',function(){rwg.searchManager.doWfsSearch(searchBar);});pagingBar.registerTrigger('zoomToExtent',function(){searchBar.zoomToExtent();});searchBar.featureGrid=new Ext.grid.GridPanel({title:EasySDI_Map.lang.getLocal("GP_FEATURE_LIST"),view:gridView,height:202,store:store,columns:attrs.columns,bbar:pagingBar,selModel:selectionModel});searchBar.featureGrid.colModel.type=SData.searchLayer.featureType.replace('{geom}','');searchBar.featureGrid.colModel.on("hiddenchange",this._colHiddenChange,this);this._addContextMenu(searchBar,searchBar.featureGrid,searchBar.gridConfig,this._getFeatureMenu.createDelegate(this),true);},_colHiddenChange:function(cm,col,hidden){var visibleCols=Ext.state.Manager.get(cm.type+'Cols',null);var colName=cm.getColumnById(col).dataIndex;if(visibleCols===null){visibleCols=SData.defaultAttrs[cm.type];}
if(hidden){for(var i=0;i<visibleCols.length;i++){if(colName==visibleCols[i]){visibleCols.splice(i,1);}}}else{visibleCols.push(colName);}
Ext.state.Manager.set(cm.type+'Cols',visibleCols);},_initFeatureStore:function(protocol,layer,fields,searchBar){var proxy=new GeoExt.data.ProtocolProxy({protocol:protocol});var store=new GeoExt.data.FeatureStore({layer:layer,fields:fields,proxy:proxy});store.on('load',function(){Ext.Msg.hide();if(store.data.length>=componentParams.maxFeatures){Ext.Msg.alert(EasySDI_Map.lang.getLocal("GP_TOO_MUCH_DATA"),EasySDI_Map.lang.getLocal("GP_TOO_MUCH_DATA_DESC"));}},this);store.on('loadexception',function(e){Ext.Msg.hide();Ext.Msg.alert(EasySDI_Map.lang.getLocal("GP_LAYER_ACCESS_ERROR"),e.response.priv.statusText);},this);return store;},_initDistinctTabs:function(searchBar){var distinctGrid,store,gridView,grid,attrs;searchBar.distinctGrids=[];Ext.each(searchBar.gridConfig.distinctResultsGrids,function(gridName){grid=SData.distinctResultsGrids[gridName];attrs=this._loadAttrs(grid.featureType.replace('{geom}',''));store=new Ext.data.Store({fields:attrs.fields});gridView=new EasySDI_Map.PagingGridView();distinctGrid=new Ext.grid.GridPanel({title:grid.title,height:202,store:store,columns:attrs.columns,view:gridView,cls:'distinctGrid',loadMask:{msg:EasySDI_Map.lang.getLocal('FGR_LOADING')+'...'},bbar:new EasySDI_Map.PagingToolbar({store:store,displayName:grid.title,pageSize:7,featureType:grid.featureType,displayInfo:true,displayMsg:EasySDI_Map.lang.getLocal("GP_PAGE_FOOTER_DET"),gridView:gridView,includeReportDownload:true,listDetailsFeatureType:grid.featureType,searchDesc:searchBar.searchDesc,searchType:"ADDN_"+grid.title,searchSpatial:searchBar.searchSpatial,idField:grid.distinctPk}),listeners:{'activate':{fn:function(tab){this._loadDistinctTab(tab,searchBar);},single:true,scope:this}}});distinctGrid.gridConfig=grid;searchBar.distinctGrids.push(distinctGrid);this._addContextMenu(searchBar,distinctGrid,grid,this._getDistinctMenu.createDelegate(this));},this);},_loadDistinctTab:function(tab,searchBar){var distinctVals=[];var filters=[];Ext.each(searchBar.featureGrid.store.data.items,function(occurrence){if(distinctVals.indexOf(occurrence.data[tab.gridConfig.distinctFk])==-1){distinctVals.push(occurrence.data[tab.gridConfig.distinctFk]);filters.push(new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:tab.gridConfig.distinctPk,value:occurrence.data[tab.gridConfig.distinctFk]}));}},this);var attrs=this._loadAttrs(tab.gridConfig.featureType.replace('{geom}',''));var protocol=new OpenLayers.Protocol.WFS({url:componentParams.proxiedPubWfsUrl,featureNS:componentParams.pubFeatureNS,featurePrefix:componentParams.pubFeaturePrefix,featureType:tab.gridConfig.featureType,filter:new OpenLayers.Filter.Logical({filters:filters,type:OpenLayers.Filter.Logical.OR}),srsName:componentParams.projection,version:"1.0.0"});var store=this._initFeatureStore(protocol,null,attrs.fields);tab.reconfigure(store,new Ext.grid.ColumnModel(attrs.columns));tab.colModel.type=tab.gridConfig.featureType;tab.colModel.on("hiddenchange",this._colHiddenChange,this);tab.getBottomToolbar().setStore(store);tab.getBottomToolbar().refresh();store.load();},_addContextMenu:function(searchBar,gridCtrl,gridConfig,menuFunction,params){gridCtrl.on('cellcontextmenu',function(grid,rowIndex,cellIndex,e){e.stopEvent();var coords=e.getXY();var row=grid.store.data.items[rowIndex];var menu=menuFunction(grid,searchBar,row,gridConfig,params);menu.showAt([coords[0],coords[1]]);},this);},_getFeatureMenu:function(grid,searchBar,row,gridConfig,allowHighlight){if(typeof gridConfig.rowDetailsFeatureType=="undefined"){if(typeof gridConfig.featureType=="undefined"){gridConfig.rowDetailsFeatureType=SData.searchLayer.rowDetailsFeatureType;}else{gridConfig.rowDetailsFeatureType=gridConfig.featureType;}}
var addCommentCaption=(user.loggedIn&&typeof SData.commentFeatureType!=="undefined")?EasySDI_Map.lang.getLocal('GP_VIEW_ADD_COMMENTS'):EasySDI_Map.lang.getLocal('GP_VIEW_COMMENTS');var menu=new Ext.menu.Menu([{text:EasySDI_Map.lang.getLocal('FDR_TITLE_'+gridConfig.rowDetailsFeatureType.replace('{geom}','')),iconCls:'externalRpt',handler:function(evt){this._showDetailsRpt(row.data.feature.data[componentParams.featureIdAttribute],gridConfig.rowDetailsFeatureType,componentParams.featureIdAttribute);},scope:this},{text:EasySDI_Map.lang.getLocal('GP_HIGHLIGHT_ON_MAP'),iconCls:'highlightFeature',handler:function(evt){this.trigger('highlightFeature',row.data.feature);},hidden:!allowHighlight,scope:this},{text:EasySDI_Map.lang.getLocal('GP_ZOOM_ON_MAP'),iconCls:'zoom',handler:function(){this.trigger('zoomToExtent',row.data.feature.geometry.getBounds());},scope:this},{text:addCommentCaption,iconCls:'commentAdd',handler:function(evt){this.trigger('featurePopup',row.data[componentParams.featureIdAttribute]);},scope:this}]);return menu;},_getDistinctMenu:function(grid,searchBar,row,gridConfig){var menu=new Ext.menu.Menu([{text:EasySDI_Map.lang.getLocal('FDR_TITLE_'+gridConfig.rowDetailsFeatureType),iconCls:'externalRpt',handler:function(){this._showDetailsRpt(row.data[gridConfig.distinctPk],gridConfig.rowDetailsFeatureType,gridConfig.distinctPk);},scope:this,hidden:typeof gridConfig.rowDetailsFeatureType=="undefined"||gridConfig.rowDetailsFeatureType===null},{text:EasySDI_Map.lang.getLocal('GP_HIGHLIGHT_ON_MAP'),iconCls:'highlightFeature',handler:function(){this.trigger('clearSelection');Ext.each(searchBar.featureGrid.store.data.items,function(item){if(item.data[gridConfig.distinctFk]==row.data[gridConfig.distinctPk]){this.trigger('highlightFeature',item.data.feature);}},this);},scope:this}]);return menu;},_showDetailsRpt:function(pkValue,rowDetailsFeatureType,rowDetailsPk){window.open(componentParams.componentUrl+'&view=featureDetails&type='+rowDetailsFeatureType+'&filter='+pkValue+'&filterfield='+rowDetailsPk);},incCommentCount:function(featureId){var idx;Ext.each(this.tabPanel.items.items,function(grid){if(grid.cls!=='distinctGrid'){idx=grid.store.findBy(function(record,id){return record.data[componentParams.featureIdAttribute]==featureId;});if(idx>-1&&grid.title!=EasySDI_Map.lang.getLocal("GP_SEL_LIST")){grid.store.data.items[idx].data[SData.commentFeatureType.featureCommentCount]++;}
if(grid.rendered){grid.view.refresh();}}},this);}});Ext.mixin(EasySDI_Map.GridPanel,EasySDI_Map.TriggerManager);